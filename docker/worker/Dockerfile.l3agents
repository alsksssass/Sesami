# ====================================================================
# L3-Agents Dockerfile
# ====================================================================
# 고비용 LLM 기반 분석 에이전트 컨테이너
#
# 에이전트:
#   - Proficiency Agent: 코드 숙련도 평가
#   - Architecture Agent: 아키텍처 패턴 분석
#   - Collaboration Agent: 협업 패턴 분석
#
# 특징:
#   - LLM 사용 (Bedrock Claude 3.5 Sonnet)
#   - Graph-RAG + Vector-RAG 도구 활용
#   - L2-Filter 통과한 유의미한 파일만 분석 (10%)
# ====================================================================

FROM python:3.11-slim

WORKDIR /app

# 시스템 패키지 설치
RUN apt-get update && apt-get install -y \
    git \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Python 패키지 설치
COPY src/worker/requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# L3-Agents 전용 의존성
RUN pip install --no-cache-dir \
    neo4j==5.15.0 \
    opensearch-py==2.4.2 \
    boto3==1.34.34 \
    langchain==0.1.0 \
    langchain-aws==0.1.0 \
    tiktoken==0.5.2

# 작업 디렉토리 복사
COPY src/worker /app
COPY src/shared /shared

# EFS 마운트 포인트 생성
RUN mkdir -p /mnt/efs

# Celery Worker 실행
CMD ["celery", "-A", "celery_app", "worker", "--loglevel=info", "--concurrency=2", "-Q", "l3_agents"]
