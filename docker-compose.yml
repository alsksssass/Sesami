# ====================================================================
# Sesami PDD v4.0 - Docker Compose Configuration
# ====================================================================
#
# Architecture:
#   L1: Backend API + Main Orchestrator (FastAPI)
#   L2: Sub Orchestrator (로컬: Celery, AWS: Step Functions)
#   L3: Batch Jobs (L3-Tools, L3-Builders, L3-Agents)
#
# 로컬 개발 환경에서는 Celery Chain으로 L1/L2/L3를 시뮬레이션합니다.
# AWS 환경에서는 Step Functions + AWS Batch로 대체됩니다.
# ====================================================================

networks:
  analyzer-net:
    driver: bridge

# ====================================================================
# 서비스 정의
# ====================================================================
services:
  # ==================================================================
  # L1: Backend API + Main Orchestrator (FastAPI)
  # ==================================================================
  backend:
    build:
      context: .
      dockerfile: ./docker/backend/Dockerfile
    command: uvicorn main:app --host ${BACKEND_HOST} --port ${BACKEND_PORT} --reload
    ports:
      - "${BACKEND_PORT}:${BACKEND_PORT}"
    volumes:
      - ./src/backend:/app
      - ./src/shared:/app/shared  # Event Envelope 스키마 공유
      - efs_mock:/mnt/efs  # L2 결과 저장용 (AWS EFS 시뮬레이션)
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - FRONTEND_URL=${FRONTEND_URL}
      - TASK_SERVICE_IMPL=${TASK_SERVICE_IMPL:-LOCAL}
      - AWS_REGION=${AWS_REGION}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - EFS_MOUNT_PATH=/mnt/efs
      - PYTHONPATH=/app
    env_file:
      - .env
    networks:
      - analyzer-net
    # depends_on:
    #   db:
    #     condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:${BACKEND_PORT}/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 20s

  # ==================================================================
  # Frontend (React + Vite)
  # ==================================================================
  frontend:
    build:
      context: .
      dockerfile: ./docker/frontend/Dockerfile
    command: npm run dev -- --host 0.0.0.0
    ports:
      - "${FRONTEND_PORT:-5173}:5173"
    volumes:
      - ./src/frontend:/app
      - /app/node_modules  # node_modules를 컨테이너 내부에서 관리
    environment:
      - VITE_API_URL=${BACKEND_URL}:${BACKEND_PORT}/api
      - VITE_BACKEND_URL=${VITE_BACKEND_URL}
    env_file:
      - .env
    networks:
      - analyzer-net
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5173 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
  # ==================================================================
  # 3. Nginx Reverse Proxy (Frontend Builder + Backend 의존)
  # ==================================================================
  nginx:
    build:
      context: .
      dockerfile: ./docker/nginx/Dockerfile
    ports:
      - "${NGINX_PORT:-80}:80"
    volumes:
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    networks:
      - analyzer-net
    # depends_on:
    #   backend:
    #     condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --quiet --tries=1 --spider http://localhost/health || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 15s
    restart: unless-stopped


  # ==================================================================
  # Infrastructure Services
  # ==================================================================

  # PostgreSQL 데이터베이스 (분석 메타데이터, 사용자 정보)
  # db:
  #   build:
  #     context: .
  #     dockerfile: ./docker/db/Dockerfile
  #   environment:
  #     - POSTGRES_USER=${POSTGRES_USER}
  #     - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
  #     - POSTGRES_DB=${POSTGRES_DB}
  #   env_file:
  #     - .env
  #   ports:
  #     - "${DB_PORT}:5432"
  #   volumes:
  #     - postgres_data:/var/lib/postgresql/data
  #   networks:
  #     - analyzer-net
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5
  #     start_period: 10s

# ====================================================================
# 영속성 볼륨
# ====================================================================
volumes:
  postgres_data:
    driver: local
  efs_mock:
    driver: local
